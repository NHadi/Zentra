<!-- Statistics Row -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-muted mb-0">Total SPK</h5>
                        <span class="h2 font-weight-bold mb-0" id="totalSPK">0</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-gradient-primary text-white rounded-circle shadow">
                            <i class="ni ni-collection"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-muted mb-0">In Progress</h5>
                        <span class="h2 font-weight-bold mb-0" id="inProgressSPK">0</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-gradient-warning text-white rounded-circle shadow">
                            <i class="ni ni-time-alarm"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-muted mb-0">Completed</h5>
                        <span class="h2 font-weight-bold mb-0" id="completedSPK">0</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-gradient-success text-white rounded-circle shadow">
                            <i class="ni ni-check-bold"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-muted mb-0">Total Cost</h5>
                        <span class="h2 font-weight-bold mb-0" id="totalCost">0</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                            <i class="ni ni-money-coins"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grid Section -->
<div class="row mt-4">
    <div class="col">
        <div class="card">
            <!-- Card header -->
            <div class="card-header border-0">
                <div class="row align-items-center">
                    <div class="col">
                        <h3 class="mb-0">Work Orders (SPK)</h3>
                    </div>
                    <div class="col text-right">
                        <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#addSPKModal">
                            <i class="fas fa-plus"></i> Add SPK
                        </button>
                    </div>
                </div>
            </div>
            <!-- Grid container -->
            <div id="spkGrid"></div>
        </div>
    </div>
</div>

<!-- Master Detail Template -->
<script type="text/html" id="spkDetailTemplate">
    <div class="master-detail-container">
        <!-- Header Section -->
        <div class="detail-header">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="header-icon">
                        <i class="ni ni-single-copy-04"></i>
                    </div>
                </div>
                <div class="col">
                    <h4 class="mb-1"><%- spk_number %></h4>
                    <p class="text-sm mb-0"><%- description %></p>
                </div>
                <div class="col-auto">
                    <span class="status-badge status-<%- status.toLowerCase() %>">
                        <%- status %>
                    </span>
                </div>
            </div>
        </div>

        <!-- Content Section -->
        <div class="detail-content">
            <div class="row">
                <!-- Left Column - SPK Details -->
                <div class="col-lg-4">
                    <div class="info-card">
                        <div class="info-card-header">
                            <h5><i class="ni ni-bullet-list-67 mr-2"></i>SPK Details</h5>
                        </div>
                        <div class="info-card-body">
                            <div class="info-item">
                                <label>Order Number</label>
                                <div class="value"><%- order_number %></div>
                            </div>
                            <div class="info-item">
                                <label>Customer</label>
                                <div class="value"><%- customer %></div>
                            </div>
                            <div class="info-item">
                                <label>Work Type</label>
                                <div class="value"><span class="badge badge-soft-primary"><%- work_type %></span></div>
                            </div>
                            <div class="info-item">
                                <label>Assigned To</label>
                                <div class="value"><%- assigned_to %></div>
                            </div>
                            <div class="info-item">
                                <label>Start Date</label>
                                <div class="value"><%- start_date %></div>
                            </div>
                            <div class="info-item">
                                <label>End Date</label>
                                <div class="value"><%- end_date %></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Column - Tasks -->
                <div class="col-lg-4">
                    <div class="info-card">
                        <div class="info-card-header">
                            <h5><i class="ni ni-check-bold mr-2"></i>Tasks</h5>
                        </div>
                        <div class="info-card-body">
                            <div class="task-list">
                                <% tasks.forEach(function(task) { %>
                                <div class="task-item">
                                    <div class="task-status">
                                        <span class="status-indicator status-<%- task.status.toLowerCase() %>"></span>
                                    </div>
                                    <div class="task-content">
                                        <div class="task-name"><%- task.name %></div>
                                        <div class="task-meta">
                                            <span class="task-status-text status-<%- task.status.toLowerCase() %>">
                                                <%- task.status %>
                                            </span>
                                            <span class="task-due-date">Due: <%- task.due_date %></span>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Items -->
                <div class="col-lg-4">
                    <div class="info-card">
                        <div class="info-card-header">
                            <h5><i class="ni ni-box-2 mr-2"></i>Items</h5>
                        </div>
                        <div class="info-card-body">
                            <div class="table-responsive">
                                <table class="table table-sm align-items-center">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th class="text-right">Qty</th>
                                            <th class="text-right">Price</th>
                                            <th class="text-right">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% items.forEach(function(item) { %>
                                        <tr>
                                            <td><%- item.description %></td>
                                            <td class="text-right"><%- item.quantity %></td>
                                            <td class="text-right">$<%- item.unit_price.toFixed(2) %></td>
                                            <td class="text-right">$<%- item.total_price.toFixed(2) %></td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3" class="text-right"><strong>Total:</strong></td>
                                            <td class="text-right"><strong>$<%- total_cost.toFixed(2) %></strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<style>
/* Master Detail Styles */
.master-detail-container {
    padding: 1.5rem;
    background: #f8f9fe;
}

.detail-header {
    background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%);
    padding: 1.5rem;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
    color: white;
}

.header-icon {
    width: 3rem;
    height: 3rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 600;
    font-size: 0.875rem;
}

.status-badge.status-completed {
    background: rgba(45, 206, 137, 0.1);
    color: #2dce89;
}

.status-badge.status-in-progress {
    background: rgba(251, 99, 64, 0.1);
    color: #fb6340;
}

.status-badge.status-pending {
    background: rgba(136, 152, 170, 0.1);
    color: #8898aa;
}

.info-card {
    background: white;
    border-radius: 0.375rem;
    box-shadow: 0 0 2rem 0 rgba(136, 152, 170, 0.15);
    margin-bottom: 1.5rem;
}

.info-card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.info-card-header h5 {
    margin: 0;
    color: #32325d;
    font-size: 1rem;
    font-weight: 600;
}

.info-card-body {
    padding: 1.5rem;
}

.info-item {
    margin-bottom: 1rem;
}

.info-item:last-child {
    margin-bottom: 0;
}

.info-item label {
    display: block;
    color: #8898aa;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.info-item .value {
    color: #32325d;
    font-weight: 500;
}

.badge-soft-primary {
    color: #5e72e4;
    background: rgba(94, 114, 228, 0.1);
}

/* Task List Styles */
.task-list {
    margin: -0.75rem;
}

.task-item {
    display: flex;
    align-items: flex-start;
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
}

.task-item:last-child {
    border-bottom: none;
}

.task-status {
    margin-right: 1rem;
}

.status-indicator {
    display: block;
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    margin-top: 0.25rem;
}

.status-indicator.status-completed {
    background: #2dce89;
}

.status-indicator.status-in-progress {
    background: #fb6340;
}

.status-indicator.status-pending {
    background: #8898aa;
}

.task-content {
    flex: 1;
}

.task-name {
    font-weight: 500;
    color: #32325d;
    margin-bottom: 0.25rem;
}

.task-meta {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
}

.task-status-text {
    font-weight: 600;
    margin-right: 1rem;
}

.task-status-text.status-completed {
    color: #2dce89;
}

.task-status-text.status-in-progress {
    color: #fb6340;
}

.task-status-text.status-pending {
    color: #8898aa;
}

.task-due-date {
    color: #8898aa;
}

/* Table Styles */
.table th {
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025rem;
    color: #8898aa;
    border-top: none;
}

.table td {
    color: #32325d;
    font-weight: 500;
}

.table tfoot tr td {
    border-top: 2px solid #e9ecef;
    font-weight: 600;
    color: #32325d;
}
</style>

<!-- SPK Details Modal -->
<div class="modal fade" id="spkDetailsModal" tabindex="-1" role="dialog" aria-labelledby="spkDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="spkDetailsModalLabel">SPK Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <!-- Tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-tab="spkInfo" role="tab">
                            <i class="ni ni-paper-diploma mr-2"></i>SPK Info
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-tab="tasks" role="tab">
                            <i class="ni ni-tasks mr-2"></i>Tasks
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-tab="items" role="tab">
                            <i class="ni ni-box-2 mr-2"></i>Items
                        </a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content p-4">
                    <!-- SPK Info Tab -->
                    <div class="tab-pane fade show active" id="spkInfo" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-control-label text-muted">SPK Number</label>
                                    <p id="spkNumber" class="h4 mb-3"></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-control-label text-muted">Order Number</label>
                                    <p id="orderNumber" class="h4 mb-3"></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-control-label text-muted">Customer Name</label>
                                    <p id="customerName" class="mb-3"></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-control-label text-muted">Work Type</label>
                                    <p id="workType" class="mb-3"></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-control-label text-muted">Description</label>
                                    <p id="description" class="mb-3"></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-control-label text-muted">Start Date</label>
                                    <p id="startDate" class="mb-3"></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-control-label text-muted">End Date</label>
                                    <p id="endDate" class="mb-3"></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-control-label text-muted">Status</label>
                                    <p id="status" class="mb-3"></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-control-label text-muted">Assigned To</label>
                                    <p id="assignedTo" class="mb-3"></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-control-label text-muted">Estimated Cost</label>
                                    <p id="estimatedCost" class="mb-3"></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-control-label text-muted">Actual Cost</label>
                                    <p id="actualCost" class="mb-3"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tasks Tab -->
                    <div class="tab-pane fade" id="tasks" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table align-items-center table-flush">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Task Name</th>
                                        <th>Description</th>
                                        <th>Assigned To</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksList">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Items Tab -->
                    <div class="tab-pane fade" id="items" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table align-items-center table-flush">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total Price</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsList">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editSPKBtn">Edit SPK</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit SPK Modal -->
<div class="modal fade" id="addSPKModal" tabindex="-1" role="dialog" aria-labelledby="addSPKModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSPKModalLabel">Add New SPK</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addSPKForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-control-label" for="input-order">Order <span class="text-danger">*</span></label>
                                <select id="input-order" class="form-control" required>
                                    <option value="">Select order</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-control-label" for="input-customer">Customer Name <span class="text-danger">*</span></label>
                                <input type="text" id="input-customer" class="form-control" placeholder="Enter customer name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-control-label" for="input-work-type">Work Type <span class="text-danger">*</span></label>
                                <select id="input-work-type" class="form-control" required>
                                    <option value="">Select work type</option>
                                    <option value="production">Production</option>
                                    <option value="repair">Repair</option>
                                    <option value="maintenance">Maintenance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-control-label" for="input-start-date">Start Date <span class="text-danger">*</span></label>
                                <input type="datetime-local" id="input-start-date" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-control-label" for="input-description">Description <span class="text-danger">*</span></label>
                                <textarea id="input-description" class="form-control" rows="3" placeholder="Enter description" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-control-label" for="input-end-date">End Date <span class="text-danger">*</span></label>
                                <input type="datetime-local" id="input-end-date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-control-label" for="input-assigned-to">Assigned To <span class="text-danger">*</span></label>
                                <select id="input-assigned-to" class="form-control" required>
                                    <option value="">Select employee</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-control-label" for="input-estimated-cost">Estimated Cost</label>
                                <input type="number" id="input-estimated-cost" class="form-control" placeholder="Enter estimated cost">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSPKBtn">Save SPK</button>
            </div>
        </div>
    </div>
</div> 